language: c

env:
  - AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=1 AFL_NO_UI=1

before_install:
  - sudo apt update
  - sudo apt install -y libtool libtool-bin automake bison libglib2.0

# TODO: Look into splitting off some builds using a build matrix.
script:
  - make
  - ./afl-gcc ./test-instr.c -o test-instr-gcc
  - mkdir seeds
  - echo "" > seeds/nil_seed
  - timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-instr-gcc
  - rm -r out/*
  - ./afl-clang ./test-instr.c -o test-instr-clang
  - timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang
  - make clean
  - CC=clang CXX=clang++ make
  - cd llvm_mode
# TODO: Build with different versions of clang/LLVM since LLVM passes don't have
# a stable API.
  - CC=clang CXX=clang++ LLVM_CONFIG=llvm-config make
  - cd ..
  - rm -r out/*
  - ./afl-clang-fast ./test-instr.c -o test-instr-clang-fast
  - timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang-fast
  - cd qemu_mode
  - ./build_qemu_support.sh
  - cd ..
  - gcc ./test-instr.c -o test-no-instr
  - timeout --preserve-status 5s ./afl-fuzz -Q -i seeds -o out/ -- ./test-no-instr
